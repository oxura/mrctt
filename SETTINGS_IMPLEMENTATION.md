# Company Settings Implementation

## Overview
Реализована страница настроек компании с тремя вкладками: Общие настройки, Модули и Статусы лидов.

## Features Implemented

### 1. General Settings (Общие настройки)
- **Название компании**: Редактирование названия компании
- **Логотип компании**: Загрузка/удаление логотипа (до 2MB, JPEG/PNG/GIF/WebP)
- **Валюта**: Выбор валюты по умолчанию (RUB, USD, EUR, KZT, UAH)

### 2. Modules Settings (Модули системы)
- **Products (Продукты)**: Управление каталогом продуктов и услуг
- **Groups (Группы/Потоки)**: Управление группами студентов или турами
- **Tasks (Задачи/Календарь)**: Планирование задач и напоминаний
- **Team (Команда)**: Управление пользователями и ролями

Отключенные модули автоматически скрываются в боковом меню.

### 3. Lead Statuses Settings (Статусы лидов)
- **Добавление статусов**: Создание новых статусов воронки
- **Удаление статусов**: Удаление ненужных статусов (минимум 1 статус)
- **Переименование**: Изменение названий статусов
- **Изменение цветов**: Настройка цветов для каждого статуса (hex color picker)
- **Изменение порядка**: Перемещение статусов вверх/вниз для изменения порядка

## Backend Changes

### Database Migration
- **00020_lead_statuses_settings.sql**:
  - Удаляет жесткий CHECK constraint на поле `leads.status`
  - Добавляет поле `lead_statuses` в `tenant.settings` (JSONB)
  - Инициализирует дефолтные статусы для существующих тенантов

### API Endpoints
- **PUT /api/v1/tenants/current/settings**: Обновление всех настроек компании
  - Accepts: name, logo_url, currency, modules, lead_statuses

### Updated Services
- **tenantService.updateSettings()**: Новый метод для обновления настроек
  - Валидация уникальности ключей статусов
  - Сортировка статусов по порядку
  - Санитизация настроек модулей

### Types Updated
- **TenantLeadStatusSetting**: Новый интерфейс для статуса лида
  - key: string (уникальный идентификатор)
  - label: string (название статуса)
  - color: string (hex цвет)
  - order: number (порядок сортировки)

## Frontend Changes

### New Components
1. **Tabs.tsx**: Компонент вкладок для переключения между разделами настроек
2. **Toggle.tsx**: Компонент переключателя для включения/выключения модулей
3. **Settings.tsx**: Главная страница настроек с управлением вкладками
4. **GeneralSettings.tsx**: Вкладка общих настроек
5. **ModulesSettings.tsx**: Вкладка управления модулями
6. **LeadStatusesSettings.tsx**: Вкладка редактора статусов лидов

### Updated Files
- **types/index.ts**: Добавлены типы TenantLeadStatus
- **data/leads.ts**: Обновлена логика для работы с кастомными статусами
  - normalizeLeadStatuses(): Нормализация статусов из tenant settings
  - buildLeadStatusMeta(): Построение метаданных статусов для UI
- **components/navigation/Sidebar.tsx**: Уже поддерживает динамическое скрытие модулей
- **design-system.css**: Добавлены CSS переменные для совместимости

### Integration Points
- **AuthStore**: Используется для получения и обновления tenant информации
- **Toast Notifications**: Показ уведомлений об успехе/ошибках операций

## Usage

### Accessing Settings
Пользователи с ролями `owner` или `admin` могут получить доступ к настройкам через:
- Боковое меню → "Настройки"
- URL: `/settings`

### Module Configuration Flow
1. Перейти в Settings → Modules
2. Включить/выключить нужные модули
3. Нажать "Сохранить изменения"
4. Перезагрузить страницу для обновления меню

### Lead Statuses Configuration Flow
1. Перейти в Settings → Lead Statuses
2. Добавить/удалить/переименовать статусы
3. Изменить цвета и порядок
4. Нажать "Сохранить изменения"
5. Новые статусы применятся к воронке лидов

## Notes
- Статусы лидов хранятся в `tenant.settings.lead_statuses` как JSON массив
- При отсутствии кастомных статусов используются дефолтные значения
- Sidebar автоматически реагирует на изменение модулей через Zustand store
- Все изменения требуют прав `tenants:update` (owner/admin)

## Future Improvements
- Реальная загрузка файлов на сервер (сейчас base64 в JSON)
- Drag & drop для изменения порядка статусов
- Предпросмотр изменений перед сохранением
- Валидация конфликтов при изменении статусов (проверка на существующие лиды)
